# =====================================================
# STAGE 1: Downloader - Fetch and prepare binaries
# =====================================================
# Use a lightweight Alpine image to handle downloads
FROM alpine:3.19 as downloader

# Install curl and tar for downloading and extracting files
RUN apk add --no-cache curl tar

# 1. Download and prepare kubectl
# Fetch the latest stable version of Kubernetes CLI
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" 
    && chmod +x kubectl

# 2. Download and prepare Helm
# Define Helm version for easy updates
ENV HELM_VERSION=v3.17.4
RUN curl -L "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz" | tar -xz 
    && mv linux-amd64/helm /helm

# =====================================================
# STAGE 2: Final Image - The actual Jenkins runtime
# =====================================================
FROM jenkins/jenkins:lts

# Switch to root user to install system packages and copy binaries
USER root

# --- COPY BINARIES FROM STAGE 1 ---
# Copy only the necessary binaries, leaving behind build tools and cache
COPY --from=downloader /kubectl /usr/local/bin/kubectl
COPY --from=downloader /helm /usr/local/bin/helm

# Install git (required for helm plugins) and clean up apt cache
RUN apt-get update && apt-get install -y --no-install-recommends 
    git 
    && rm -rf /var/lib/apt/lists/*

# Ensure the binaries are executable
RUN chmod +x /usr/local/bin/kubectl /usr/local/bin/helm

# --- SWITCH BACK TO JENKINS USER ---
USER jenkins

# Install Helm Push Plugin
RUN helm plugin install https://github.com/chartmuseum/helm-push

# Final verification check
RUN kubectl version --client && helm version
