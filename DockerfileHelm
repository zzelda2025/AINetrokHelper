# =====================================================
# STAGE 1: Downloader - Fetch and prepare binaries
# =====================================================
FROM alpine:3.19 as downloader

# Gộp các lệnh RUN để giảm layers
RUN apk add --no-cache curl tar

# 1. Download and prepare kubectl
# Đã sửa lỗi: Dùng "\" để nối lệnh
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl

# 2. Download and prepare Helm
# Đã sửa lỗi: Dùng "\" để nối lệnh
ENV HELM_VERSION=v3.17.4
RUN curl -L "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz" | tar -xz \
    && mv linux-amd64/helm /helm

# =====================================================
# STAGE 2: Final Image - The actual Jenkins runtime
# =====================================================
FROM jenkins/jenkins:lts

# Switch to root user to install system packages and copy binaries
USER root

# --- COPY BINARIES FROM STAGE 1 ---
# Copy chỉ các binaries cần thiết
COPY --from=downloader /kubectl /usr/local/bin/kubectl
COPY --from=downloader /helm /usr/local/bin/helm

# Install git (required for helm plugins) và dọn dẹp cache
RUN apt-get update && apt-get install -y --no-install-recommends git \
    && rm -rf /var/lib/apt/lists/*

# Đảm bảo các binaries có thể thực thi
RUN chmod +x /usr/local/bin/kubectl /usr/local/bin/helm

# --- SWITCH BACK TO JENKINS USER ---
USER jenkins

# Install Helm Push Plugin (thêm cờ -y)
RUN helm plugin install https://github.com/chartmuseum/helm-push -y

# Final verification check
RUN kubectl version --client && helm version
