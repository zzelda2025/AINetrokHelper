pipeline {
    agent any
    
    environment {
        // --- C·∫§U H√åNH HARBOR & IMAGE ---
        HARBOR_DOMAIN_NAME = "harbor.vinhthai.io.vn"
        APP_IMAGE_NAME = "harbor.vinhthai.io.vn/template-ainetwork/ai-network-config-helper"
        HELM_CHART_NAME = "template-ainetwork" 
        
        // --- CREDENTIALS ---
        REGISTRY_LOGIN_ID = 'harbor-registry-creds'
        // üî• BI·∫æN QUAN TR·ªåNG: ID c·ªßa Secret ch·ª©a API Key trong Jenkins üî•
        GEMINI_API_KEY_ID = 'gemini-api-key' 
        
        // --- DYNAMIC TAGS & PATHS ---
        DOCKER_TAG = "0.1.${env.BUILD_NUMBER}" 
        BUILD_DIR = "helm_build_area" 
        SOURCE_DIR = "../helm" 
    }

    stages {
        stage('Stage 1: Checkout Source Code') {
            steps {
                echo "INFO: Starting source code checkout..."
                cleanWs() 
                checkout scm
                echo "INFO: Source code checkout completed successfully."
            }
        }

        // ============================================================
        // üî• STAGE M·ªöI: TI√äM API KEY V√ÄO CODE (QUAN TR·ªåNG NH·∫§T) üî•
        // ============================================================
        stage('Inject API Key') {
            steps {
                echo "üíâ Injecting API Key into source code..."
                withCredentials([string(credentialsId: "${GEMINI_API_KEY_ID}", variable: 'GEMINI_API_KEY')]) {
                    sh '''
                    # T√¨m chu·ªói process.env.API_KEY trong file ts v√† thay b·∫±ng Key th·∫≠t
                    # L·ªánh n√†y l·∫•y t·ª´ Jenkinsfile c≈© c·ªßa b·∫°n
                    sed -i "s|process.env.API_KEY|\\"${GEMINI_API_KEY}\\"|g" services/geminiService.ts
                    '''
                }
                echo "‚úÖ API Key injected successfully!"
            }
        }

        stage('Stage 2: Build & Push Docker Image') { 
            steps {
                echo "INFO: Building Docker Image version: ${DOCKER_TAG}..."
                
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh 'echo $REG_PASS | docker login ${HARBOR_DOMAIN_NAME} -u $REG_USER --password-stdin'
                }
                
                // 1. Build Docker image 
                // üî• L∆ØU √ù: D√πng 'Dockerfile' (file c·ªßa App), KH√îNG PH·∫¢I 'DockerfileHelm' üî•
                sh "docker build -f Dockerfile -t ${APP_IMAGE_NAME}:${DOCKER_TAG} ."
                
                // 2. Push Image
                sh "docker push ${APP_IMAGE_NAME}:${DOCKER_TAG}"
                
                // 3. Push latest tag
                sh "docker tag ${APP_IMAGE_NAME}:${DOCKER_TAG} ${APP_IMAGE_NAME}:latest"
                sh "docker push ${APP_IMAGE_NAME}:latest"
                
                sh "docker logout ${HARBOR_DOMAIN_NAME}"
            }
        }
        
        stage('Stage 3: Package & Publish Helm Chart') { 
            steps {
                echo "INFO: Preparing to package Helm Chart version: ${DOCKER_TAG}..."
                
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh 'echo $REG_PASS | helm registry login ${HARBOR_DOMAIN_NAME} -u $REG_USER --password-stdin'
                }
                
                script {
                    def chartName = "${HELM_CHART_NAME}" 
                    
                    // Clean workspace for helm build
                    sh "rm -rf ${BUILD_DIR} && mkdir ${BUILD_DIR}"
                    
                    dir("${BUILD_DIR}") {
                        // 1. Create Chart Scaffold
                        sh "helm create ${chartName}"
                        sh "rm -rf ${chartName}/templates/*" 
                        
                        // 2. Copy Manifests from Git
                        echo "INFO: Copying manifest files..."
                        sh "cp -f ${SOURCE_DIR}/values.yaml ${chartName}/values.yaml"
                        sh "cp ${SOURCE_DIR}/_helpers.tpl ${chartName}/templates/"
                        sh "cp ${SOURCE_DIR}/deployment.yaml ${chartName}/templates/"
                        sh "cp ${SOURCE_DIR}/service.yaml ${chartName}/templates/"
                        sh "cp ${SOURCE_DIR}/ingress.yaml ${chartName}/templates/"
                        
                        // 3. Update Image Tag in values.yaml
                        echo "INFO: Updating 'values.yaml' with new image tag: ${DOCKER_TAG}"
                        if (isUnix()) {
                            sh "sed -i 's|tag: .*|tag: ${DOCKER_TAG}|g' ${chartName}/values.yaml"
                        }
                        
                        // 4. Package & Push Helm Chart
                        sh "helm package ${chartName} --version ${DOCKER_TAG} --app-version ${DOCKER_TAG}"
                        echo "INFO: Pushing Helm Chart to OCI Registry..."
                        sh "helm push ${chartName}-${DOCKER_TAG}.tgz oci://${HARBOR_DOMAIN_NAME}/${HELM_CHART_NAME}" 
                    }
                }
                sh "helm registry logout ${HARBOR_DOMAIN_NAME}"
            }
        }
    } 

    post {
        always {
            echo "üèÅ Pipeline finished. Build Version: ${DOCKER_TAG}"
        }
        success {
            echo '‚úÖ SUCCESS: Artifacts are ready in Harbor.'
        }
        failure {
            echo '‚ùå FAILED: Please check Console Output.'
        }
    }    
}
