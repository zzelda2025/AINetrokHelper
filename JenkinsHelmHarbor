pipeline {
    agent any
    
    environment {
        // Docker Registry Configuration
        HARBOR_REGISTRY_URL = 'harbor.vinhthai.io.vn'
        HARBOR_PROJECT = 'template-ainetwork'
        IMAGE_NAME = 'ai-network-config-helper'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        HARBOR_CREDENTIALS_ID = 'harbor-registry-creds'
        
        // API Key
        GEMINI_API_KEY_ID = 'gemini-api-key'
        
        // GitOps Repository Configuration (QUAN TRá»ŒNG!)
        GITOPS_REPO_URL = 'git@github.com:zzelda2025/AINetrokHelper-Config.git'
        GITOPS_REPO_BRANCH = 'main'
        GITOPS_SSH_KEY_ID = 'gitops-repo-ssh-key'
        
        // Helm Chart path trong GitOps repo
        HELM_CHART_PATH = 'helm/ai-network-config-helper'
        HELM_VALUES_FILE = 'values.yaml'
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
                echo "ðŸ”„ Láº¥y mÃ£ nguá»“n tá»« GitHub (triggered by webhook)..."
                checkout scm
            }
        }
        
        stage('Inject API Key') {
            steps {
                echo "ðŸ”‘ TiÃªm API Key vÃ o source code..."
                withCredentials([string(credentialsId: "${GEMINI_API_KEY_ID}", variable: 'GEMINI_API_KEY')]) {
                    sh '''
                    sed -i "s|process.env.API_KEY|\\"${GEMINI_API_KEY}\\"|g" services/geminiService.ts
                    '''
                }
            }
        }
        
        stage('Build and Push Docker Image') {
            steps {
                script {
                    echo "ðŸ³ Build vÃ  Push Docker Image lÃªn Harbor Registry..."
                    withCredentials([usernamePassword(
                        credentialsId: "${HARBOR_CREDENTIALS_ID}",
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                    )]) {
                        sh '''
                        set -e
                        
                        # Login to Harbor (bá» qua SSL verify náº¿u dÃ¹ng self-signed cert)
                        echo "ðŸ” Logging in to Harbor..."
                        echo $HARBOR_PASS | docker login ${HARBOR_REGISTRY_URL} -u $HARBOR_USER --password-stdin
                        
                        # Build image
                        echo "ðŸ—ï¸ Building Docker image..."
                        FULL_IMAGE_PATH="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
                        FULL_IMAGE_LATEST="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest"
                        
                        docker build -t ${FULL_IMAGE_PATH} .
                        docker tag ${FULL_IMAGE_PATH} ${FULL_IMAGE_LATEST}
                        
                        # Push to Harbor
                        echo "â¬†ï¸ Pushing images to Harbor..."
                        docker push ${FULL_IMAGE_PATH}
                        docker push ${FULL_IMAGE_LATEST}
                        
                        echo "âœ… Docker images pushed successfully!"
                        
                        # Logout
                        docker logout ${HARBOR_REGISTRY_URL}
                        '''
                    }
                }
            }
        }
        
        stage('Update GitOps Repository') {
            steps {
                echo "ðŸ“ Cáº­p nháº­t GitOps Repository vá»›i image tag má»›i..."
                withCredentials([sshUserPrivateKey(
                    credentialsId: "${GITOPS_SSH_KEY_ID}",
                    keyFileVariable: 'SSH_KEY',
                    usernameVariable: 'SSH_USER'
                )]) {
                    sh '''
                    set -e
                    
                    # Setup SSH
                    echo "ðŸ” Setting up SSH..."
                    mkdir -p ~/.ssh
                    cp ${SSH_KEY} ~/.ssh/id_rsa
                    chmod 600 ~/.ssh/id_rsa
                    ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
                    
                    # Configure Git
                    git config --global user.email "jenkins@vinhthai.io.vn"
                    git config --global user.name "Jenkins CI Bot"
                    
                    # Clone GitOps repository
                    echo "ðŸ“‚ Cloning GitOps repository..."
                    rm -rf gitops-repo
                    git clone ${GITOPS_REPO_URL} gitops-repo
                    cd gitops-repo
                    git checkout ${GITOPS_REPO_BRANCH}
                    
                    # Kiá»ƒm tra xem Helm chart Ä‘Ã£ tá»“n táº¡i chÆ°a
                    if [ ! -d "${HELM_CHART_PATH}" ]; then
                        echo "âš ï¸ Helm chart chÆ°a tá»“n táº¡i, táº¡o structure má»›i..."
                        mkdir -p ${HELM_CHART_PATH}/templates
                        
                        # Táº¡o Chart.yaml
                        cat > ${HELM_CHART_PATH}/Chart.yaml <<EOF
apiVersion: v2
name: ai-network-config-helper
description: A Helm chart for AI Network Config Helper
type: application
version: 1.0.0
appVersion: "1.0.0"
EOF
                        
                        # Táº¡o values.yaml cÆ¡ báº£n
                        cat > ${HELM_CHART_PATH}/${HELM_VALUES_FILE} <<EOF
replicaCount: 1

image:
  repository: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}
  pullPolicy: Always
  tag: "${IMAGE_TAG}"

imagePullSecrets:
  - name: harbor-registry-secret

service:
  type: ClusterIP
  port: 3000
  targetPort: 3000

ingress:
  enabled: false

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

nodeSelector: {}
tolerations: []
affinity: {}
EOF
                        
                        # Táº¡o deployment.yaml template cÆ¡ báº£n
                        cat > ${HELM_CHART_PATH}/templates/deployment.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ai-network-config-helper.fullname" . }}
  labels:
    {{- include "ai-network-config-helper.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "ai-network-config-helper.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "ai-network-config-helper.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
EOF
                        
                        # Táº¡o service.yaml template
                        cat > ${HELM_CHART_PATH}/templates/service.yaml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: {{ include "ai-network-config-helper.fullname" . }}
  labels:
    {{- include "ai-network-config-helper.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "ai-network-config-helper.selectorLabels" . | nindent 4 }}
EOF
                        
                        # Táº¡o _helpers.tpl
                        cat > ${HELM_CHART_PATH}/templates/_helpers.tpl <<'EOF'
{{- define "ai-network-config-helper.fullname" -}}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- end }}

{{- define "ai-network-config-helper.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{- define "ai-network-config-helper.selectorLabels" -}}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}
EOF
                        
                        echo "âœ… ÄÃ£ táº¡o Helm chart structure"
                    fi
                    
                    # Copy custom templates tá»« source code náº¿u cÃ³
                    if [ -d "${WORKSPACE}/helm/templates" ]; then
                        echo "ðŸ“‹ Copying custom templates from source..."
                        cp -rf ${WORKSPACE}/helm/templates/* ${HELM_CHART_PATH}/templates/
                    fi
                    
                    # Cáº­p nháº­t image tag trong values.yaml
                    echo "ðŸ”„ Updating image tag to: ${IMAGE_TAG}"
                    sed -i "s|tag:.*|tag: \\"${IMAGE_TAG}\\"|g" ${HELM_CHART_PATH}/${HELM_VALUES_FILE}
                    
                    # Cáº­p nháº­t repository náº¿u cáº§n
                    sed -i "s|repository:.*|repository: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}|g" ${HELM_CHART_PATH}/${HELM_VALUES_FILE}
                    
                    # Show changes
                    echo "ðŸ“„ Changes in values.yaml:"
                    git diff ${HELM_CHART_PATH}/${HELM_VALUES_FILE}
                    
                    # Commit and push
                    git add .
                    
                    if git diff-index --quiet HEAD --; then
                        echo "âš ï¸ No changes to commit"
                    else
                        echo "ðŸ’¾ Committing changes..."
                        git commit -m "ðŸš€ CI: Update ${IMAGE_NAME} to tag ${IMAGE_TAG} [Build #${BUILD_NUMBER}]"
                        
                        echo "â¬†ï¸ Pushing to GitOps repository..."
                        git push origin ${GITOPS_REPO_BRANCH}
                        
                        echo "âœ… GitOps repository updated successfully!"
                    fi
                    
                    # Cleanup
                    cd ..
                    rm -rf gitops-repo
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo """
            âœ… ============================================
            âœ… CI BUILD THÃ€NH CÃ”NG!
            âœ… ============================================
            ðŸ“¦ Docker Image: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}
            ðŸ“ GitOps Repo: ${GITOPS_REPO_URL}
            ðŸŽ¯ Branch: ${GITOPS_REPO_BRANCH}
            
            ðŸ”„ ArgoCD sáº½ tá»± Ä‘á»™ng phÃ¡t hiá»‡n thay Ä‘á»•i vÃ  deploy lÃªn K8s
            âœ… ============================================
            """
        }
        failure {
            echo """
            âŒ ============================================
            âŒ CI BUILD THáº¤T Báº I!
            âŒ ============================================
            ðŸ” Vui lÃ²ng kiá»ƒm tra logs Ä‘á»ƒ biáº¿t chi tiáº¿t
            âŒ ============================================
            """
        }
        always {
            echo "ðŸ§¹ Dá»n dáº¹p..."
            sh '''
                # Cleanup docker images
                docker image prune -f || true
                
                # Cleanup SSH keys
                rm -f ~/.ssh/id_rsa || true
                
                # Cleanup git repos
                rm -rf gitops-repo || true
            '''
        }
    }
}
