pipeline {
    agent any
    
    environment {
        // Docker Registry Configuration
        HARBOR_REGISTRY_URL = 'harbor.vinhthai.io.vn'
        HARBOR_PROJECT = 'template-ainetwork'
        IMAGE_NAME = 'ai-network-config-helper'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        HARBOR_CREDENTIALS_ID = 'harbor-registry-creds'
        
        // API Key
        GEMINI_API_KEY_ID = 'gemini-api-key'
        
        // Helm Configuration
        HELM_CHART_NAME = 'ai-network-config-helper'
        HELM_CHART_VERSION = "1.0.${env.BUILD_NUMBER}"
        HELM_REPO_NAME = 'harbor-helm'
        HELM_HARBOR_URL = "https://${HARBOR_REGISTRY_URL}/chartrepo/${HARBOR_PROJECT}"
        
        // Local paths
        HELM_SOURCE_DIR = 'helm'  // Th∆∞ m·ª•c helm trong source code
        HELM_BUILD_DIR = 'helm-package'  // Th∆∞ m·ª•c ƒë·ªÉ build helm chart
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ L·∫•y m√£ ngu·ªìn t·ª´ GitHub (triggered by webhook)..."
                checkout scm
            }
        }
        
        stage('Inject API Key') {
            steps {
                echo "üîë Ti√™m API Key v√†o source code..."
                withCredentials([string(credentialsId: "${GEMINI_API_KEY_ID}", variable: 'GEMINI_API_KEY')]) {
                    sh '''
                    sed -i "s|process.env.API_KEY|\\"${GEMINI_API_KEY}\\"|g" services/geminiService.ts
                    '''
                }
            }
        }
        
        stage('Build and Push Docker Image') {
            steps {
                script {
                    echo "üê≥ Build v√† Push Docker Image l√™n Harbor Registry..."
                    withCredentials([usernamePassword(
                        credentialsId: "${HARBOR_CREDENTIALS_ID}",
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                    )]) {
                        sh '''
                        # Login to Harbor
                        echo $HARBOR_PASS | docker login ${HARBOR_REGISTRY_URL} -u $HARBOR_USER --password-stdin
                        
                        # Build image
                        FULL_IMAGE_PATH="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
                        FULL_IMAGE_LATEST="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest"
                        
                        docker build -t ${FULL_IMAGE_PATH} .
                        docker tag ${FULL_IMAGE_PATH} ${FULL_IMAGE_LATEST}
                        
                        # Push to Harbor
                        docker push ${FULL_IMAGE_PATH}
                        docker push ${FULL_IMAGE_LATEST}
                        
                        # Logout
                        docker logout ${HARBOR_REGISTRY_URL}
                        '''
                    }
                }
            }
        }
        
        stage('Prepare Helm Chart') {
            steps {
                echo "üì¶ Chu·∫©n b·ªã Helm Chart..."
                sh '''
                # T·∫°o th∆∞ m·ª•c build
                mkdir -p ${HELM_BUILD_DIR}
                
                # Ki·ªÉm tra xem ƒë√£ c√≥ helm chart structure ch∆∞a
                if [ ! -d "${HELM_SOURCE_DIR}" ]; then
                    echo "‚ö†Ô∏è Th∆∞ m·ª•c helm ch∆∞a t·ªìn t·∫°i, t·∫°o template m·ªõi..."
                    mkdir -p ${HELM_SOURCE_DIR}
                    helm create ${HELM_SOURCE_DIR}/${HELM_CHART_NAME}
                else
                    echo "‚úÖ Th∆∞ m·ª•c helm ƒë√£ t·ªìn t·∫°i"
                fi
                
                # Copy helm chart t·ª´ source sang build directory
                cp -r ${HELM_SOURCE_DIR}/* ${HELM_BUILD_DIR}/
                
                # N·∫øu structure helm ch∆∞a ƒë√∫ng, t·∫°o chart m·ªõi
                if [ ! -f "${HELM_BUILD_DIR}/Chart.yaml" ]; then
                    echo "T·∫°o Helm chart structure..."
                    cd ${HELM_BUILD_DIR}
                    helm create ${HELM_CHART_NAME}
                    cd ..
                fi
                '''
            }
        }
        
        stage('Update Helm Values') {
            steps {
                echo "‚öôÔ∏è C·∫≠p nh·∫≠t Helm values v√† templates..."
                sh '''
                # ƒê∆∞·ªùng d·∫´n ƒë·∫øn chart
                CHART_PATH="${HELM_BUILD_DIR}/${HELM_CHART_NAME}"
                
                # C·∫≠p nh·∫≠t Chart.yaml
                cat > ${CHART_PATH}/Chart.yaml <<EOF
apiVersion: v2
name: ${HELM_CHART_NAME}
description: A Helm chart for AI Network Config Helper
type: application
version: ${HELM_CHART_VERSION}
appVersion: "${IMAGE_TAG}"
EOF

                # C·∫≠p nh·∫≠t values.yaml v·ªõi th√¥ng tin image m·ªõi
                cat > ${CHART_PATH}/values.yaml <<EOF
replicaCount: 1

image:
  repository: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}
  pullPolicy: Always
  tag: "${IMAGE_TAG}"

imagePullSecrets:
  - name: harbor-registry-secret

service:
  type: ClusterIP
  port: 3000

ingress:
  enabled: false

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false

nodeSelector: {}
tolerations: []
affinity: {}
EOF

                # N·∫øu c√≥ template t√πy ch·ªânh trong source, copy v√†o
                if [ -d "${HELM_SOURCE_DIR}/templates" ]; then
                    echo "üìã Copy custom templates t·ª´ source code..."
                    cp -f ${HELM_SOURCE_DIR}/templates/* ${CHART_PATH}/templates/ 2>/dev/null || true
                fi
                
                # N·∫øu c√≥ values t√πy ch·ªânh, merge v√†o
                if [ -f "${HELM_SOURCE_DIR}/values.yaml" ]; then
                    echo "üìã Merge custom values t·ª´ source code..."
                    # Backup default values
                    cp ${CHART_PATH}/values.yaml ${CHART_PATH}/values.default.yaml
                    # Copy custom values (c√≥ th·ªÉ c·∫ßn tool merge ph·ª©c t·∫°p h∆°n)
                    cp ${HELM_SOURCE_DIR}/values.yaml ${CHART_PATH}/values.custom.yaml
                fi
                
                echo "‚úÖ Helm chart ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t"
                cat ${CHART_PATH}/Chart.yaml
                '''
            }
        }
        
        stage('Package Helm Chart') {
            steps {
                echo "üì¶ ƒê√≥ng g√≥i Helm Chart..."
                sh '''
                cd ${HELM_BUILD_DIR}
                
                # Validate chart
                helm lint ${HELM_CHART_NAME}
                
                # Package chart
                helm package ${HELM_CHART_NAME}
                
                # List package
                ls -lh *.tgz
                '''
            }
        }
        
        stage('Push Helm Chart to Harbor') {
            steps {
                echo "üöÄ Push Helm Chart l√™n Harbor Registry..."
                withCredentials([usernamePassword(
                    credentialsId: "${HARBOR_CREDENTIALS_ID}",
                    usernameVariable: 'HARBOR_USER',
                    passwordVariable: 'HARBOR_PASS'
                )]) {
                    sh '''
                    cd ${HELM_BUILD_DIR}
                    
                    # C√†i ƒë·∫∑t helm push plugin n·∫øu ch∆∞a c√≥
                    helm plugin list | grep -q push || helm plugin install https://github.com/chartmuseum/helm-push
                    
                    # Add Harbor helm repo
                    helm repo add ${HELM_REPO_NAME} ${HELM_HARBOR_URL} \
                        --username ${HARBOR_USER} \
                        --password ${HARBOR_PASS}
                    
                    # Push chart to Harbor
                    CHART_PACKAGE="${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz"
                    
                    # Method 1: Using helm-push plugin
                    helm cm-push ${CHART_PACKAGE} ${HELM_REPO_NAME} || \
                    
                    # Method 2: Using curl (fallback)
                    curl -u ${HARBOR_USER}:${HARBOR_PASS} \
                         -X POST \
                         --data-binary "@${CHART_PACKAGE}" \
                         "${HELM_HARBOR_URL}/api/charts"
                    
                    echo "‚úÖ Helm chart ƒë√£ ƒë∆∞·ª£c push l√™n Harbor"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo """
            ‚úÖ ============================================
            ‚úÖ BUILD TH√ÄNH C√îNG!
            ‚úÖ ============================================
            üì¶ Docker Image: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}
            üì¶ Helm Chart: ${HELM_CHART_NAME}-${HELM_CHART_VERSION}
            üéØ Harbor Project: ${HARBOR_PROJECT}
            ‚úÖ ============================================
            """
        }
        failure {
            echo """
            ‚ùå ============================================
            ‚ùå BUILD TH·∫§T B·∫†I!
            ‚ùå ============================================
            üîç Vui l√≤ng ki·ªÉm tra logs ƒë·ªÉ bi·∫øt chi ti·∫øt
            ‚ùå ============================================
            """
        }
        always {
            echo "üßπ D·ªçn d·∫πp..."
            sh '''
                # Cleanup docker images
                docker image prune -f || true
                
                # Cleanup helm build directory
                rm -rf ${HELM_BUILD_DIR} || true
            '''
        }
    }
}
