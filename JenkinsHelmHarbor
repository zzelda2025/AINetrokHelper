pipeline {
    agent any
    
    environment {
        // Docker Registry Configuration
        HARBOR_REGISTRY_URL = 'harbor.vinhthai.io.vn'
        HARBOR_PROJECT = 'template-ainetwork'
        IMAGE_NAME = 'ai-network-config-helper'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        HARBOR_CREDENTIALS_ID = 'harbor-registry-creds'
        
        // API Key
        GEMINI_API_KEY_ID = 'gemini-api-key'
        
        // Helm Configuration
        HELM_CHART_NAME = 'ai-network-config-helper'
        // Version format: MAJOR.MINOR.BUILD (e.g., 1.0.1, 1.0.2, ...)
        HELM_CHART_VERSION = "1.0.${env.BUILD_NUMBER}"
        
        // Workspace paths
        HELM_SOURCE_DIR = 'helm'
        HELM_BUILD_DIR = 'helm-build'
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
                echo "ðŸ”„ Láº¥y mÃ£ nguá»“n tá»« GitHub (triggered by webhook)..."
                checkout scm
            }
        }
        
        stage('Inject API Key') {
            steps {
                echo "ðŸ”‘ TiÃªm API Key vÃ o source code..."
                withCredentials([string(credentialsId: "${GEMINI_API_KEY_ID}", variable: 'GEMINI_API_KEY')]) {
                    sh '''
                    if [ -f "services/geminiService.ts" ]; then
                        sed -i.bak "s|process.env.API_KEY|\\"${GEMINI_API_KEY}\\"|g" services/geminiService.ts
                        rm -f services/geminiService.ts.bak
                        echo "âœ… API Key injected successfully"
                    else
                        echo "âš ï¸ File services/geminiService.ts not found, skipping..."
                    fi
                    '''
                }
            }
        }
        
        stage('Build and Push Docker Image') {
            steps {
                script {
                    echo "ðŸ³ Build vÃ  Push Docker Image lÃªn Harbor Registry..."
                    withCredentials([usernamePassword(
                        credentialsId: "${HARBOR_CREDENTIALS_ID}",
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                    )]) {
                        sh '''
                        set -e
                        
                        # Login to Harbor
                        echo "ðŸ” Logging in to Harbor..."
                        echo $HARBOR_PASS | docker login ${HARBOR_REGISTRY_URL} -u $HARBOR_USER --password-stdin
                        
                        # Build image
                        echo "ðŸ—ï¸ Building Docker image..."
                        FULL_IMAGE_PATH="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
                        FULL_IMAGE_LATEST="${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest"
                        
                        docker build -t ${FULL_IMAGE_PATH} .
                        docker tag ${FULL_IMAGE_PATH} ${FULL_IMAGE_LATEST}
                        
                        # Push to Harbor
                        echo "â¬†ï¸ Pushing images to Harbor..."
                        docker push ${FULL_IMAGE_PATH}
                        docker push ${FULL_IMAGE_LATEST}
                        
                        echo "âœ… Docker images pushed successfully!"
                        
                        # Logout
                        docker logout ${HARBOR_REGISTRY_URL}
                        '''
                    }
                }
            }
        }
        
        stage('Prepare Helm Chart') {
            steps {
                echo "ðŸ“¦ Chuáº©n bá»‹ Helm Chart..."
                sh '''
                set -e
                
                # Clean and create build directory
                rm -rf ${HELM_BUILD_DIR}
                mkdir -p ${HELM_BUILD_DIR}/${HELM_CHART_NAME}
                
                # Copy Helm files from source code
                if [ -d "${HELM_SOURCE_DIR}" ]; then
                    echo "âœ… Found helm directory in source code"
                    
                    # Copy all files
                    cp -r ${HELM_SOURCE_DIR}/* ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/
                    
                    echo "âœ“ Copied Helm chart from source"
                else
                    echo "âš ï¸ No helm directory found, creating basic structure..."
                    
                    # Create basic structure
                    mkdir -p ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/templates
                    
                    # Create Chart.yaml
                    cat > ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/Chart.yaml <<'EOFCHART'
apiVersion: v2
name: ai-network-config-helper
description: A Helm chart for AI Network Config Helper
type: application
version: 1.0.0
appVersion: "1.0.0"
EOFCHART
                    
                    # Create values.yaml
                    cat > ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/values.yaml <<EOFVALUES
replicaCount: 1

image:
  repository: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}
  pullPolicy: Always
  tag: "latest"

imagePullSecrets:
  - name: harbor-registry-secret

service:
  type: ClusterIP
  port: 3000
  targetPort: 3000

ingress:
  enabled: false

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false

nodeSelector: {}
tolerations: []
affinity: {}
EOFVALUES
                    
                    # Create deployment.yaml
                    cat > ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/templates/deployment.yaml <<'EOFDEPLOY'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ai-network-config-helper.fullname" . }}
  labels:
    {{- include "ai-network-config-helper.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "ai-network-config-helper.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "ai-network-config-helper.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
EOFDEPLOY
                    
                    # Create service.yaml
                    cat > ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/templates/service.yaml <<'EOFSERVICE'
apiVersion: v1
kind: Service
metadata:
  name: {{ include "ai-network-config-helper.fullname" . }}
  labels:
    {{- include "ai-network-config-helper.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "ai-network-config-helper.selectorLabels" . | nindent 4 }}
EOFSERVICE
                    
                    # Create _helpers.tpl
                    cat > ${HELM_BUILD_DIR}/${HELM_CHART_NAME}/templates/_helpers.tpl <<'EOFHELPERS'
{{- define "ai-network-config-helper.fullname" -}}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- end }}

{{- define "ai-network-config-helper.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{- define "ai-network-config-helper.selectorLabels" -}}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}
EOFHELPERS
                    
                    echo "âœ… Created basic Helm chart structure"
                fi
                
                # List structure
                echo "ðŸ“‚ Helm chart structure:"
                find ${HELM_BUILD_DIR}/${HELM_CHART_NAME} -type f
                '''
            }
        }
        
        stage('Update Helm Chart Metadata') {
            steps {
                echo "âš™ï¸ Cáº­p nháº­t Helm Chart metadata..."
                sh '''
                set -e
                
                CHART_PATH="${HELM_BUILD_DIR}/${HELM_CHART_NAME}"
                
                # Update Chart.yaml with correct version
                echo "ðŸ“ Updating Chart.yaml..."
                sed -i.bak "s|^version:.*|version: ${HELM_CHART_VERSION}|g" ${CHART_PATH}/Chart.yaml
                sed -i.bak "s|^appVersion:.*|appVersion: \\"${IMAGE_TAG}\\"|g" ${CHART_PATH}/Chart.yaml
                rm -f ${CHART_PATH}/Chart.yaml.bak
                
                # Update values.yaml with new image tag
                echo "ðŸ”„ Updating values.yaml with image tag: ${IMAGE_TAG}"
                sed -i.bak "s|tag:.*|tag: \\"${IMAGE_TAG}\\"|g" ${CHART_PATH}/values.yaml
                sed -i.bak "s|repository:.*|repository: ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}|g" ${CHART_PATH}/values.yaml
                rm -f ${CHART_PATH}/values.yaml.bak
                
                # Display Chart.yaml
                echo "ðŸ“„ Chart.yaml content:"
                cat ${CHART_PATH}/Chart.yaml
                
                echo ""
                echo "ðŸ“„ Image configuration in values.yaml:"
                grep -A 3 "^image:" ${CHART_PATH}/values.yaml || true
                '''
            }
        }
        
        stage('Validate and Package Helm Chart') {
            steps {
                echo "ðŸ” Validate vÃ  Package Helm Chart..."
                sh '''
                set -e
                
                cd ${HELM_BUILD_DIR}
                
                # Lint the chart
                echo "ðŸ” Linting Helm chart..."
                helm lint ${HELM_CHART_NAME}
                
                # Package the chart
                echo "ðŸ“¦ Packaging Helm chart..."
                helm package ${HELM_CHART_NAME}
                
                # List packaged chart
                echo "ðŸ“¦ Packaged chart:"
                ls -lh *.tgz
                
                # Verify package content
                echo "ðŸ“‹ Chart package content:"
                tar -tzf ${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz | head -20
                '''
            }
        }
        
        stage('Push Helm Chart to Harbor OCI Registry') {
            steps {
                echo "ðŸš€ Push Helm Chart lÃªn Harbor OCI Registry..."
                withCredentials([usernamePassword(
                    credentialsId: "${HARBOR_CREDENTIALS_ID}",
                    usernameVariable: 'HARBOR_USER',
                    passwordVariable: 'HARBOR_PASS'
                )]) {
                    sh '''
                    set -e
                    
                    cd ${HELM_BUILD_DIR}
                    
                    CHART_PACKAGE="${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz"
                    OCI_REGISTRY="oci://${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}"
                    
                    # Verify package exists
                    if [ ! -f "$CHART_PACKAGE" ]; then
                        echo "âŒ Chart package not found: $CHART_PACKAGE"
                        ls -la
                        exit 1
                    fi
                    
                    echo "ðŸ“¦ Chart package: $CHART_PACKAGE"
                    echo "ðŸŽ¯ Target registry: $OCI_REGISTRY"
                    
                    # Login to Harbor OCI Registry
                    echo "ðŸ” Logging in to Harbor OCI Registry..."
                    echo $HARBOR_PASS | helm registry login ${HARBOR_REGISTRY_URL} \\
                        --username $HARBOR_USER \\
                        --password-stdin
                    
                    # Push to Harbor OCI Registry
                    echo "â¬†ï¸ Pushing Helm chart to Harbor..."
                    helm push $CHART_PACKAGE $OCI_REGISTRY
                    
                    echo "âœ… Helm chart pushed successfully!"
                    echo "ðŸ“ Chart location: ${OCI_REGISTRY}/${HELM_CHART_NAME}:${HELM_CHART_VERSION}"
                    
                    # Logout
                    helm registry logout ${HARBOR_REGISTRY_URL}
                    '''
                }
            }
        }
        
        stage('Verify Helm Chart in Harbor') {
            steps {
                echo "âœ… Verify Helm Chart trong Harbor..."
                withCredentials([usernamePassword(
                    credentialsId: "${HARBOR_CREDENTIALS_ID}",
                    usernameVariable: 'HARBOR_USER',
                    passwordVariable: 'HARBOR_PASS'
                )]) {
                    sh '''
                    set -e
                    
                    OCI_CHART="oci://${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${HELM_CHART_NAME}"
                    
                    echo "ðŸ” Verifying chart in Harbor..."
                    echo "ðŸ“ Chart: ${OCI_CHART}:${HELM_CHART_VERSION}"
                    
                    # Login again
                    echo $HARBOR_PASS | helm registry login ${HARBOR_REGISTRY_URL} \\
                        --username $HARBOR_USER \\
                        --password-stdin
                    
                    # Try to pull the chart to verify
                    echo "ðŸ“¥ Testing pull from Harbor..."
                    helm pull ${OCI_CHART} --version ${HELM_CHART_VERSION} --destination /tmp
                    
                    if [ -f "/tmp/${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz" ]; then
                        echo "âœ… Chart verified successfully in Harbor!"
                        rm -f /tmp/${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz
                    else
                        echo "âš ï¸ Chart verification failed!"
                    fi
                    
                    # Logout
                    helm registry logout ${HARBOR_REGISTRY_URL}
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo """
            âœ… ============================================
            âœ… PIPELINE HOÃ€N Táº¤T THÃ€NH CÃ”NG!
            âœ… ============================================
            
            ðŸ“¦ DOCKER IMAGE:
            â””â”€ ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}
            â””â”€ ${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest
            
            ðŸ“¦ HELM CHART (OCI):
            â””â”€ oci://${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}/${HELM_CHART_NAME}:${HELM_CHART_VERSION}
            
            ðŸŽ¯ ARGOCD APPLICATION:
            â””â”€ Chart: ${HELM_CHART_NAME}
            â””â”€ RepoURL: oci://${HARBOR_REGISTRY_URL}/${HARBOR_PROJECT}
            â””â”€ Version: ${HELM_CHART_VERSION}
            
            ðŸ“ NEXT STEPS:
            1. Táº¡o/Update ArgoCD Application vá»›i version: ${HELM_CHART_VERSION}
            2. Hoáº·c dÃ¹ng targetRevision: "1.0.*" Ä‘á»ƒ auto-update
            3. Sync ArgoCD Ä‘á»ƒ deploy lÃªn K8s
            
            âœ… ============================================
            """
        }
        failure {
            echo """
            âŒ ============================================
            âŒ PIPELINE THáº¤T Báº I!
            âŒ ============================================
            ðŸ” Vui lÃ²ng kiá»ƒm tra logs á»Ÿ stage bá»‹ lá»—i
            âŒ ============================================
            """
        }
        always {
            echo "ðŸ§¹ Dá»n dáº¹p..."
            sh '''
                # Cleanup docker images
                docker image prune -f || true
                
                # Cleanup build directory
                rm -rf ${HELM_BUILD_DIR} || true
                
                # Cleanup temp files
                rm -f /tmp/${HELM_CHART_NAME}-*.tgz || true
            '''
        }
    }
}
