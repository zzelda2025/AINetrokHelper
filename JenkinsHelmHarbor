pipeline {
    agent any
    
    environment {
        // Harbor Registry Domain
        HARBOR_DOMAIN_NAME = "harbor.vinhthai.io.vn"
        
        // Base Image Name (Tag will be appended dynamically during the build process)
        APP_IMAGE_NAME = "harbor.vinhthai.io.vn/template-ainetwork/ai-network-config-helper"
        
        // üî• BI·∫æN M·ªöI: T√™n Helm Chart/Project trong Harbor üî•
        HELM_CHART_NAME = "template-ainetwork" 
        
        // Jenkins Credentials ID for Harbor Registry
        REGISTRY_LOGIN_ID = 'harbor-registry-creds'
        
        // CRITICAL: Define dynamic Docker Tag based on Jenkins Build Number
        DOCKER_TAG = "0.1.${env.BUILD_NUMBER}" 
        
        // üî• NEW: Chart Build Directory üî•
        BUILD_DIR = "helm_build_area" 
        
        // üî• NEW: Source Directory in Git (X√°c nh·∫≠n l√† ../helm) üî•
        SOURCE_DIR = "../helm" 
    }

    stages {
        stage('Stage 1: Checkout Source Code') {
            steps {
                echo "INFO: Starting source code checkout..."
                cleanWs() // Clean workspace before starting
                checkout scm
                echo "INFO: Source code checkout completed successfully."
            }
        }

        stage('Stage 2: Build & Push Docker Image') { 
            steps {
                echo "INFO: Building Docker Image version: ${DOCKER_TAG}..."
                
                // Authenticate with Harbor Registry
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh 'echo $REG_PASS | docker login ${HARBOR_DOMAIN_NAME} -u $REG_USER --password-stdin'
                }
                
                // 1. Build Docker image with the dynamic tag
                sh "docker build -f DockerfileHelm -t ${APP_IMAGE_NAME}:${DOCKER_TAG} ."
                
                // 2. Push the specific versioned image to Harbor
                sh "docker push ${APP_IMAGE_IMAGE_NAME}:${DOCKER_TAG}"
                
                // 3. (Optional) Tag and push 'latest' for reference/backup purposes
                sh "docker tag ${APP_IMAGE_NAME}:${DOCKER_TAG} ${APP_IMAGE_NAME}:latest"
                sh "docker push ${APP_IMAGE_NAME}:latest"
                
                // Logout for security
                sh "docker logout ${HARBOR_DOMAIN_NAME}"
            }
        }
        
        // ----------------------------------------------------------------------------------
        
        stage('Stage 3: Package & Publish Helm Chart') { 
            steps {
                echo "INFO: Preparing to package Helm Chart version: ${DOCKER_TAG}..."
                
                // Authenticate Helm Client with Harbor OCI Registry
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh 'echo $REG_PASS | helm registry login ${HARBOR_DOMAIN_NAME} -u $REG_USER --password-stdin'
                }
                
                script {
                    def chartName = "${HELM_CHART_NAME}" 
                    
                    // Clean up and create fresh build area
                    sh "rm -rf ${BUILD_DIR} && mkdir ${BUILD_DIR}"
                    
                    dir("${BUILD_DIR}") {
                        // 1. Initialize Helm Chart scaffolding
                        sh "helm create ${chartName}"
                        
                        // üî• B∆Ø·ªöC KH·∫ÆC PH·ª§C L·ªñI: X√≥a tri·ªát ƒë·ªÉ t·∫•t c·∫£ c√°c file m·∫´u trong templates/ üî•
                        sh "rm -rf ${chartName}/templates/*" 
                        
                        // ============================================================
                        // üî• CH·∫®N ƒêO√ÅN L·ªñI COPY: B·∫Øt ƒë·∫ßu üî•
                        // ============================================================
                        echo "--- DEBUG: Ki·ªÉm tra th∆∞ m·ª•c ngu·ªìn ${SOURCE_DIR} ---"
                        // Ki·ªÉm tra xem c√°c file c√≥ t·ªìn t·∫°i ·ªü th∆∞ m·ª•c ngu·ªìn hay kh√¥ng
                        sh "ls -l ${SOURCE_DIR}" 
                        
                        echo "INFO: Copying manifest files..."
                        // 2. Copy source YAML files from Git into the build area
                        sh "cp -f ${SOURCE_DIR}/values.yaml ${chartName}/values.yaml"
                        sh "cp ${SOURCE_DIR}/_helpers.tpl ${chartName}/templates/" // Copy file helper n·∫øu c√≥
                        sh "cp ${SOURCE_DIR}/deployment.yaml ${chartName}/templates/"
                        sh "cp ${SOURCE_DIR}/service.yaml ${chartName}/templates/"
                        sh "cp ${SOURCE_DIR}/ingress.yaml ${chartName}/templates/"
                        
                        echo "--- DEBUG: Ki·ªÉm tra th∆∞ m·ª•c ƒë√≠ch SAU KHI COPY ---"
                        // Ph·∫£i hi·ªÉn th·ªã 4-5 file ƒë√£ ƒë∆∞·ª£c copy
                        sh "ls -l ${chartName}/templates/" 
                        // ============================================================
                        // üî• CH·∫®N ƒêO√ÅN L·ªñI COPY: K·∫øt th√∫c üî•
                        // ============================================================
                        
                        // ============================================================
                        // AUTOMATION STEP: Inject Dynamic Image Tag
                        // ============================================================
                        echo "INFO: Updating 'values.yaml' with new image tag: ${DOCKER_TAG}"
                        
                        if (isUnix()) {
                            // Use sed to find 'tag: latest' and replace it with 'tag: 0.1.xx'
                            // Th√™m flag -e ƒë·ªÉ tr√°nh l·ªói tr√™n m·ªôt s·ªë Linux distro
                            sh "sed -i -e 's|tag: latest|tag: ${DOCKER_TAG}|g' ${chartName}/values.yaml" 
                        }
                        
                        // Debug: Verify the replacement in the console logs
                        echo "--- VERIFICATION: values.yaml CONTENT ---"
                        sh "grep 'tag:' ${chartName}/values.yaml"

                        // 3. Package the Helm Chart
                        // Synchronize Chart Version and App Version with the Docker Tag
                        sh "helm package ${chartName} --version ${DOCKER_TAG} --app-version ${DOCKER_TAG}"
                        
                        // 4. Push the OCI Chart to Harbor
                        echo "INFO: Pushing Helm Chart to OCI Registry..."
                        sh "helm push ${chartName}-${DOCKER_TAG}.tgz oci://${HARBOR_DOMAIN_NAME}/${HELM_CHART_NAME}" 
                    }
                }
                
                // Logout Helm Client
                sh "helm registry logout ${HARBOR_DOMAIN_NAME}"
            }
        }
        // ----------------------------------------------------------------------------------
        
        // ... (Stage 4: Tri·ªÉn khai v·ªõi ArgoCD - T√πy ch·ªçn) ...
    } // End of stages

    // Post-build Actions
    post {
        // ... (Gi·ªØ nguy√™n) ...
    }    
}
